# OpenBlocks "Роли"

### Инициатива OpenBlocks

Инициатива OpenBlocks &mdash; это проект с открытым исходным кодом, целью которого
является предоставить открытые и масштабируемые решения уровня предприятия.

### Описание

Сервис "Роли" служит источником мастер-данных по ролям пользователей предприятия.

Этот сервис ориентируется на пользователей, предоставляемых другим сервисов в составе
OpenBlocks &mdash; ["Пользователи"](https://github.com/IgorIvkin/openblocks-users).

В рамках OpenBlocks предполагается, что все сервисы, включая UI, используют общую
платформу аутентификации на основе **Keycloak**. Ввиду этого сервис "Роли"
работает с запросами, ожидая получить в них JWT-токен, который затем будет проверен
на корпоративном Keycloak-сервере.

Сервис "Роли" служит источником ролей пользователей для других сервисов предприятия,
он может предоставлять данные о ролях пользователя по REST API, а также по Kafka при
изменениях ролей пользователя (добавление или удаление роли).

### Советы по использованию ролей

1. Не рекомендуется выдавать роли, которые отличаются друг от друга только подразделениями
в составе организации, например "Менеджер по продажам, отдел №2", "Менеджер по продажам, главный отдел".
Рекомендуется добавить общую роль "Менеджер по продажам", а привязку к подразделениям
получить из данных сервиса "Команды".

### Основная конфигурация

Обратите внимание на следующие секции в конфигурации сервиса.

```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://localhost:8534/realms/infra/protocol/openid-connect/certs
          issuer-uri: http://localhost:8534/realms/infra
```

В этом блоке задаются URL вашего сервиса Keycloak, "jwk-set-uri" служит для
получения JWKS-ключей и для последующей валидации JWT-токена, с которым приходят
запросы в сервис "Роли".


### Основные эндпойнты

#### Добавление новой роли
POST /api/v1/roles

Добавляет новую роль в сервис. Если роль с таким кодом уже существовала,
возвращается ошибка 409 Conflict.

```json
{
    "code": "ROLE_CODE",
    "label": "Название вашей роли, например, Менеджер по продажам"
}
```

---

#### Получение списка всех ролей
GET /api/v1/roles

Возвращает полный список всех ролей, заведенных в сервисе "Роли". Может быть полезно
для анализа существующих ролей или для регулярной выгрузки справочника ролей в интересах
других сервисов предприятия.

---

#### Проверка наличия роли у пользователя
POST /api/v1/user-roles/has-role

Проверяет существование у заданного пользователя заданной роли. Возвращает логическое
значение, true &mdash; если роль есть, и false, если роли не задано.

```json
{
    "userName": "test@example.com",
    "roleCode": "TEST_ROLE"
}
```


---

#### Добавление новой роли пользователю
POST /api/v1/user-roles

Добавляет пользователю новую роль по заданному коду. Если роли с таким кодом нет
в системе, возвращается ошибка 404 Not found. Если такая роль уже есть у пользователя,
то операция всё равно считается успешно выполненной.

```json
{
    "userName": "test@example.com",
    "roleCode": "TEST_ROLE"
}
```



## Полезные ссылки
* [OpenBlocks "Пользователи"](https://github.com/IgorIvkin/openblocks-users)
* [Документация по Keycloak](https://www.keycloak.org/documentation)